<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CT Log Fetcher - Dashboard</title>
    <!-- Favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/images/favicon_io/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/images/favicon_io/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/images/favicon_io/favicon-16x16.png">
    <link rel="manifest" href="/assets/images/favicon_io/site.webmanifest">
    <link rel="shortcut icon" href="/assets/images/favicon_io/favicon.ico">
    <style>
        body { font-family: sans-serif; margin: 2em; }
        h1 { color: #2c3e50; }
        table { border-collapse: collapse; width: 100%; margin-bottom: 2em; }
        th, td { border: 1px solid #ccc; padding: 0.5em; text-align: left; }
        th { background: #f4f4f4; }
        .progress-bar { background: #e0e0e0; border-radius: 4px; overflow: hidden; height: 1em; }
        .progress { background: #3498db; height: 100%; }
        .status-running { color: green; }
        .status-resume_wait { color: orange; }
        .status-finished { color: gray; }
        .highlight-green { background-color: #d4edda; }
        .error { color: red; }
        .nav-links a { margin-right: 1em; text-decoration: none; color: #3498db; }
        .red { color: red; }
        .green { color: green; }
        .diff { font-size: 0.8em; color: gray; }
    </style>
</head>
<body>
    <h1>🔍 CT Log Fetcher 📄 Dashboard</h1>

    <div class="nav-links" style="margin-bottom: 2em;">
        <a href="/">🏠 Dashboard</a>
        <a href="https://chikkuchiku.notion.site/CT-Log-267a4415c73980a98600c5cd06498da7" target="_blank">📖 研究に参加できます！</a>
        <a href="/unique_certs">🔒 Sample Certificates</a>
        <a href="/worker-status-aggs">📈 Worker Stats (Hourly)</a>
    </div>

    <section>
        <!-- Summary Section: Numbers are displayed with commas every three digits -->
        <b>Cumulative Fetched Certs:</b> {{ "{:,}".format(summary.total) }} |
        <b>Cumulative Worker Names:</b> {{ summary.cumulative_worker_names }} |
        <b>Active:</b>
            {{ "{:,}".format(summary.threads) }} threads,
            {{ "{:,}".format(summary.workers) }} workers,
            {{ "{:,}".format(logs_summary.ip_address_count) }} IPs
        &nbsp;|
        <b>Updated: </b> {{ summary.last_updated }}
        <div style="margin-top: 0.5em; margin-bottom: 0.5em; padding: 0.5em; background: #cef8ca; border-radius: 4px;">
            <b>☺️ お知らせ (2025-10-20 10:12)</b> おかげさまで過去データは収集完了し、新規データを補完している状態です。無理なworkerは起動いただかなくてもいい状態です。可能な方は引き続きご協力お願いします ☺️<br>
            <code>docker.io/kujiy/ct-worker:20250929-213931</code>
        </div>
        {% if summary.error %}
            <span class="error">⚠️ {{ summary.error }}</span>
        {% endif %}
        {% if summary.logs_progress_error %}
            <span class="error">⚠️ logs_progress API error: {{ summary.logs_progress_error }}</span>
        {% endif %}
        {% if summary.workers_status_error %}
            <span class="error">⚠️ workers_status API error: {{ summary.workers_status_error }}</span>
        {% endif %}
        {% if summary.worker_ranking_error %}
            <span class="error">⚠️ worker_ranking API error: {{ summary.worker_ranking_error }}</span>
        {% endif %}
        {% if summary.logs_summary_error %}
            <span class="error">⚠️ logs_summary API error: {{ summary.logs_summary_error }}</span>
        {% endif %}
    </section>

    <h2>Worker Ranking</h2>
    {% if snapshot_time %}
        <div style="margin-bottom: 0.5em; color: #888; float:right;">
            Diff comparison time: {{ snapshot_time.strftime('%Y-%m-%d %H:%M:%S') }}
        </div>
    {% endif %}
    <div id="worker-ranking">
        {% if worker_ranking %}
        <table>
            <tr>
                <th colspan="5">Committed Index Ranking</th>
                <th colspan="3">Last 2 Hours Metrics</th>
            </tr>
            <tr>
                <th>Rank</th>
                <th>Worker Name</th>
                <th>Fetched Cert Count</th>
                <th>.jp Count</th>
                <th>.jp Ratio</th>
                <th>Completed Rate</th>
                <th>Avg. Job</th>
                <th>Max. Job</th>
            </tr>
            {% for r in worker_ranking.worker_total_count_ranking %}
            {% set diff = ranking_diff.get(r.worker_name, {}) %}
            <tr>
                <th>
                    {{ loop.index }}
                    {% if diff.rank_diff > 0 %}
                        <span class="green" title="Up by {{ diff.rank_diff }}">▲</span>
                    {% elif diff.rank_diff < 0 %}
                        <span class="red" title="Down by {{ -diff.rank_diff }}">▼</span>
                    {% endif %}
                </th>
                <td>
                    <a href="/worker-stats/{{ r.worker_name.split(' ')[-1] }}" style="text-decoration: none; color: #3498db;">
                        {{ r.worker_name }}
                    </a>
                </td>
                <td>
                    {{ "{:,}".format(r.worker_total_count) }}
                    {% if diff.count_diff > 0 %}
                        <span class="diff" title="+{{ diff.count_diff }}">⬆️ +{{ diff.count_diff }}</span>
                    {% elif diff.count_diff < 0 %}
                        <span class="diff" title="{{ diff.count_diff }}">⬇️ {{ diff.count_diff }}</span>
                    {% endif %}
                </td>
                <td>
                    {% if r.jp_count is defined and r.jp_count > 0 %}
                        <a href="/fetched-certs/{{ r.worker_name.split(' ')[-1] }}" style="text-decoration: none; color: #3498db;">
                            {{ "{:,}".format(r.jp_count) }}
                        </a>
                        {% if diff.jp_diff > 0 %}
                            <span class="diff" title="+{{ diff.jp_diff }}">⬆️ +{{ diff.jp_diff }}</span>
                        {% elif diff.jp_diff < 0 %}
                            <span class="diff" title="{{ diff.jp_diff }}">⬇️ {{ diff.jp_diff }}</span>
                        {% endif %}
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>{% if r.committed_index is defined and r.committed_index > 0 %}{{ '%.2f' % (r.jp_ratio * 100) }}%{% elif r.jp_ratio is defined %}{{ '%.2f' % (r.jp_ratio * 100) }}%{% else %}-{% endif %}</td>
                <td>{{ r.completed_rate * 100 }} %</td>
                <td>{% if r.average_min %}{{ r.average_min }} mins{% endif %}</td>
                <td>{% if r.max_duration_min %}{{ r.max_duration_min }} mins{% endif %}</td>
            </tr>
            {% endfor %}
        </table>
        {% else %}
        <p>Could not retrieve ranking information.</p>
        {% endif %}
    </div>



    {% if logs_summary %}
    <section style="margin-bottom:2em;">
        <h2>Overall Progress</h2>
        <table>
            <tr>
                <th>Total Tree Size</th>
                <th>Fetched Tree Size</th>
                <th>ETA</th>
                <th>Unique .jp Count</th>
                <th>Progress</th>
            </tr>
            <tr>
                <td>{{ "{:,}".format(logs_summary.total_tree_size) }}</td>
                <td>{{ "{:,}".format(logs_summary.fetched_tree_size) }}</td>
                <td id="eta-countdown" data-eta-timestamp="{% if logs_summary.eta_timestamp %}{{ logs_summary.eta_timestamp }}{% endif %}">
                    {% if logs_summary.eta_timestamp %}-{% else %}-{% endif %}
                </td>
                <td class="highlight-green">
                    <a href="/unique_certs" style="text-decoration: none; color: #3498db; margin-right: 1em;">{{ "{:,}".format(logs_summary.unique_jp_count) }}</a>
                </td>
                <td>
                    {% set percent = logs_summary.fetched_rate * 100 %}
                    <div class="progress-bar"><div class="progress" style="width: {{ percent|int }}%"></div></div>
                    {{ "{:,}".format(logs_summary.fetched_tree_size) }} / {{ "{:,}".format(logs_summary.total_tree_size) }} ({{ '%.2f' % percent }}%)
                </td>
            </tr>
        </table>
    </section>
    {% endif %}



    <h2>Progress by Log</h2>
    <div style="margin-bottom: 0.5em; color: #888; float:left;">
        Completed: {{ completed_logs }} / {{ total_logs }}
    </div>
    {% if log_progress_list %}
        <div style="margin-bottom: 0.5em; color: #888; float:right;">
            Diff comparison time: {{ log_progress_list.0.diff.snapshot_timestamp }}
        </div>
        <table>
            <tr>
                <th>category</th>
                <th>log_name</th>
                <th>sth_end</th>
                <th>min_completed_end</th>
                <th>remaining</th>
                <th>status</th>
                <th>Progress</th>
            </tr>
            {% for log in log_progress_list %}
            {% set percent = log.fetch_rate * 100 %}
            {%  set completed = percent > 99 %}
            <tr class="{% if completed %}highlight-green{% endif %}">
                <th class="{% if completed %}highlight-green{% endif %}">{{ log.category }}</th>
                <th class="{% if completed %}highlight-green{% endif %}">
    <a href="/log-history/{{ log.log_name }}" style="text-decoration: none; color: #3498db;">
        {{ log.log_name }}
    </a>
</th>
                <td>
                    {{ "{:,}".format(log.sth_end) if log.sth_end is not none else '-' }}
                    {% if log.diff is mapping and 'sth_end' in log.diff and log.diff.sth_end is not none and log.diff.sth_end != 0 %}
                        <span class="diff" style="color: {% if log.diff.sth_end > 0 %}green{% elif log.diff.sth_end < 0 %}red{% endif %};">
                            ({% if log.diff.sth_end > 0 %}+{% endif %}{{ log.diff.sth_end | string }})
                        </span>
                    {% endif %}
                </td>
                <td>
                    {{ "{:,}".format(log.min_completed_end) if log.min_completed_end is not none else '-' }}
                    {% if log.diff is mapping and 'min_completed_end' in log.diff and log.diff.min_completed_end is not none and log.diff.min_completed_end != 0 %}
                        <span class="diff" style="color: {% if log.diff.min_completed_end > 0 %}green{% elif log.diff.min_completed_end < 0 %}red{% endif %};">
                            ({% if log.diff.min_completed_end > 0 %}+{% endif %}{{ log.diff.min_completed_end | string }})
                        </span>
                    {% endif %}
                </td>
                <td>
                    {% if log.sth_end is not none and log.min_completed_end is not none %}
                        {% set remaining = log.sth_end - log.min_completed_end %}
                        {% set batches = (remaining // 16000) + (1 if remaining % 16000 > 0 else 0) %}
                        {{ "{:,}".format(remaining) }}
                        <span class="diff"> ({{ batches }} jobs)</span>
                    {% endif %}

                </td>
                <td>{% if log.status == "completed" %}✅{% endif %} {{ log.status }}</td>
                <td>
                    <div class="progress-bar"><div class="progress" style="width: {{ percent|int }}%"></div></div>
                    {{ "{:,}".format(log.min_completed_end) }} / {{ "{:,}".format(log.sth_end) }} ({{ '%.2f' % percent }}%)
                </td>
            </tr>
            {% endfor %}
        </table>
    {% else %}
    <p>No logs in this category.</p>
    {% endif %}



    <h2>Status by Worker</h2>(Up to 100 most recent ping-ed workers)
    <table>
        <tr>
            <th>Worker Name</th>
            <th>Log Name</th>
            <th>Start</th>
            <th>End</th>
            <th>Current Index</th>
            <th>Last Uploaded Index</th>
            <th>Fetched Count</th>
            <th>.jp Count</th>
            <th>.jp Ratio</th>
            <th>Progress</th>
            <th>Last Ping</th>
            <th>Status</th>
        </tr>
        {% for w in workers %}
        <tr>
            <th>{{ w.worker_name }}</th>
            <td>{{ w.log_name }}</td>
            <td>{{ "{:,}".format(w.start) }}</td>
            <td>{{ "{:,}".format(w.end) }}</td>
            <td>{{ "{:,}".format(w.current) }}</td>
            <td>{{ w.last_uploaded_index if w.last_uploaded_index is not none else '' }}</td>
            <td>{{ w.worker_fetched_count }}</td>
            <td>
                {% set log = (logs | selectattr('log_name', 'equalto', w.log_name) | list | first) %}
                {{ log.jp_count if log else '' }}
            </td>
            <td>
                {% if log %}{{ '%.2f' % (log.jp_ratio * 100) }}%{% endif %}
            </td>
            <td>
                <div class="progress-bar"><div class="progress" style="width: {{ (w.progress * 100)|int }}%"></div></div>
                {{ w.worker_fetched_count }}/{{ (w.end - w.start + 1) if w.end is not none and w.start is not none else '-' }} ({{ (w.progress * 100)|int }}%)
            </td>
            <td>{% if w.last_ping %}{{ w.last_ping.strftime('%Y-%m-%d %H:%M:%S') }}{% else %}{% endif %}</td>
            <td class="status-{{ w.status }}">{{ w.status }}</td>
        </tr>
        {% endfor %}
    </table>


    <h2>API Round Trip Time</h2>
    <a href="/metrics">📊 Worker API Metrics</a>
    <table>
        <thead>
            <th>API</th>
            <th>RTT (ms)</th>
        </thead>
        <tbody>
            {% for r in round_trip_time %}
            <tr>
                <th>{{ r.api_name }}</th>
                <td>{{ '%.2f' % r.rtt if r.rtt else "-" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <script>
        // ETA Countdown Timer
        function updateCountdown() {
            var countdownElement = document.getElementById('eta-countdown');

            if (!countdownElement) {
                return;
            }

            var etaTimestamp = countdownElement.getAttribute('data-eta-timestamp');

            if (!etaTimestamp) {
                countdownElement.textContent = '-';
                return;
            }

            var targetDate = new Date(etaTimestamp);
            var now = new Date();
            var timeDiff = targetDate - now;

            // Format the completion time as YYYY-MM-DD HH:MM:SS (API already returns JST)
            var year = targetDate.getFullYear();
            var month = String(targetDate.getMonth() + 1).padStart(2, '0');
            var day = String(targetDate.getDate()).padStart(2, '0');
            var hour = String(targetDate.getHours()).padStart(2, '0');
            var minute = String(targetDate.getMinutes()).padStart(2, '0');
            var second = String(targetDate.getSeconds()).padStart(2, '0');
            var completionTimeStr = year + '-' + month + '-' + day + ' ' + hour + ':' + minute + ':' + second;

            if (timeDiff <= 0) {
                countdownElement.innerHTML = 'Completed!<br>(' + completionTimeStr + ')';
                return;
            }

            // Calculate time components
            var totalSeconds = Math.floor(timeDiff / 1000);
            var years = Math.floor(totalSeconds / (365 * 24 * 3600));
            var days = Math.floor((totalSeconds % (365 * 24 * 3600)) / (24 * 3600));
            var hours = Math.floor((totalSeconds % (24 * 3600)) / 3600);
            var minutes = Math.floor((totalSeconds % 3600) / 60);
            var seconds = totalSeconds % 60;

            // Format time components with leading zeros
            var hh = String(hours).padStart(2, '0');
            var mm = String(minutes).padStart(2, '0');
            var ss = String(seconds).padStart(2, '0');

            // Build countdown string in format: HH:MM:SS Xd Yy
            var countdownStr = hh + ':' + mm + ':' + ss;

            if (days > 0) {
                countdownStr += ' ' + days + 'd';
            }

            if (years > 0) {
                countdownStr += ' ' + years + 'y';
            }

            // Display countdown with completion time in parentheses on new line
            countdownElement.innerHTML = completionTimeStr + '<br>(' + countdownStr + ')';
        }

        // Update countdown immediately and then every second
        updateCountdown();
        setInterval(updateCountdown, 1000);
    </script>
</body>
</html>
