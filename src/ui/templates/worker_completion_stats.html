<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CT Log Fetcher - Worker Completion Statistics</title>
    <!-- Favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/images/favicon_io/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/images/favicon_io/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/images/favicon_io/favicon-16x16.png">
    <link rel="manifest" href="/assets/images/favicon_io/site.webmanifest">
    <link rel="shortcut icon" href="/assets/images/favicon_io/favicon.ico">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; margin: 2em; }
        h1 { color: #2c3e50; }
        table { border-collapse: collapse; width: 100%; margin-bottom: 2em; }
        th, td { border: 1px solid #ccc; padding: 0.5em; text-align: left; }
        th { background: #f4f4f4; }
        .nav-links a { margin-right: 1em; text-decoration: none; color: #3498db; }
        .error { color: red; }
        .chart-container { 
            position: relative; 
            height: 400px; 
            width: 100%; 
            margin-bottom: 2em; 
        }
    </style>
</head>
<body>
    <h1>üîç Worker Completion Statistics</h1>

    <div class="nav-links" style="margin-bottom: 2em;">
        <a href="/">üè† Dashboard</a>
        <a href="/metrics">üìä Metrics</a>
    </div>

    {% if error_message %}
        <div class="error">
            <p>Error: {{ error_message }}</p>
        </div>
    {% endif %}

    <section>
        <h2>Completed Workers by Hour</h2>
        <p>Showing hourly completed worker counts for the last 256 hours.</p>
        {% if query_timestamp %}
            <p>Data as of: {{ query_timestamp }}</p>
        {% endif %}
        {% if total_records %}
            <p>Total records: {{ total_records }}</p>
        {% endif %}
        
        {% if completion_stats %}
            <!-- Chart Container -->
            <div class="chart-container">
                <canvas id="completionChart"></canvas>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>Hour</th>
                        <th>Completed Count</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stat in completion_stats|reverse %}
                    <tr>
                        <td>{{ stat.hour_bucket }}</td>
                        <td>{{ stat.completed_count }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            
            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    // Prepare data for Chart.js
                    const labels = [
                        {% for stat in completion_stats %}
                            "{{ stat.hour_bucket }}",
                        {% endfor %}
                    ];
                    
                    const data = [
                        {% for stat in completion_stats %}
                            {{ stat.completed_count }},
                        {% endfor %}
                    ];
                    
                    // Create chart
                    const ctx = document.getElementById('completionChart').getContext('2d');
                    const chart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Completed Workers',
                                data: data,
                                backgroundColor: 'rgba(52, 152, 219, 0.2)',
                                borderColor: 'rgba(52, 152, 219, 1)',
                                borderWidth: 2,
                                pointRadius: 3,
                                pointBackgroundColor: 'rgba(52, 152, 219, 1)',
                                tension: 0.3
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                x: {
                                    title: {
                                        display: true,
                                        text: 'Hour'
                                    },
                                    ticks: {
                                        maxTicksLimit: 20,
                                        maxRotation: 45,
                                        minRotation: 45
                                    }
                                },
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Completed Count'
                                    }
                                }
                            },
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Worker Completion Trend',
                                    font: {
                                        size: 16
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        title: function(tooltipItems) {
                                            return tooltipItems[0].label;
                                        },
                                        label: function(context) {
                                            return 'Completed: ' + context.parsed.y;
                                        }
                                    }
                                }
                            }
                        }
                    });
                });
            </script>
        {% else %}
            <p>No completion statistics available.</p>
        {% endif %}
    </section>
</body>
</html>
