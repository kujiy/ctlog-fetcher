<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Worker Stats - {{ worker_name }}</title>
    <style>
        body { font-family: sans-serif; margin: 2em; }
        h1, h2 { color: #2c3e50; }
        table { border-collapse: collapse; width: 100%; margin-bottom: 2em; }
        th, td { border: 1px solid #ccc; padding: 0.5em; text-align: left; }
        th { background: #f4f4f4; }
        .highlight-green { background-color: #d4edda; }
        .highlight-red { background-color: #f8d7da; }
        .nav-links a { margin-right: 1em; text-decoration: none; color: #3498db; }
        .small { font-size: 0.7em }
    </style>
</head>
<body>
    <div class="nav-links" style="margin-bottom: 2em;">
        <a href="/">üè† Dashboard</a>
        <a href="/unique_certs">üîí Sample Certificates</a>
    </div>
    <h1>Worker Stats: {{ worker_name }}</h1>

    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <h2>1. Worker Status (last 24 hours, hourly)</h2>
    {% set hour_labels_py = [] -%}
    {% set total_jobs_py = [] -%}
    {% set completed_py = [] -%}
    {% set running_py = [] -%}
    {% set resume_wait_py = [] -%}
    {% set dead_py = [] -%}
    {% set completed_rate_py = [] -%}
    {%- for row in status_stats %}
        {%- set _ = hour_labels_py.append(row.hour_label) -%}
        {%- set _ = completed_py.append(row.status_counts.completed) -%}
        {%- set _ = running_py.append(row.status_counts.running) -%}
        {%- set _ = resume_wait_py.append(row.status_counts.resume_wait) -%}
        {%- set _ = dead_py.append(row.status_counts.dead) -%}
        {%- set total = row.status_counts.running + row.status_counts.completed + row.status_counts.resume_wait + row.status_counts.dead -%}
        {%- set _ = total_jobs_py.append(total) -%}
        {%- set _ = completed_rate_py.append(((row.status_counts.completed / total * 100) if total > 0 else 0) | round(2)) -%}
    {%- endfor %}
    <canvas id="statusChart" width="900" height="320" style="margin-bottom:2em;"></canvas>
    <script>
        // Prepare data arrays from Jinja2 context
        let hourLabels = {{ hour_labels_py | tojson | safe }};
        let totalJobs = {{ total_jobs_py | tojson | safe }};
        let completed = {{ completed_py | tojson | safe }};
        let running = {{ running_py | tojson | safe }};
        let resumeWait = {{ resume_wait_py | tojson | safe }};
        let dead = {{ dead_py | tojson | safe }};
        let completedRate = {{ completed_rate_py | tojson | safe }};

        // Reverse arrays for graph (so latest is rightmost)
        hourLabels = hourLabels.slice().reverse();
        completed = completed.slice().reverse();
        running = running.slice().reverse();
        resumeWait = resumeWait.slice().reverse();
        dead = dead.slice().reverse();
        completedRate = completedRate.slice().reverse();

        // Chart.js config
        const ctx = document.getElementById('statusChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: hourLabels,
                datasets: [
                    {
                        label: 'Completed',
                        data: completed,
                        backgroundColor: 'rgba(40, 167, 69, 0.5)',
                        borderColor: 'rgba(40, 167, 69, 1)',
                        borderWidth: 1,
                        yAxisID: 'y',
                        type: 'bar',
                        stack: 'jobs'
                    },
                    {
                        label: 'Running',
                        data: running,
                        backgroundColor: 'rgba(255, 193, 7, 0.5)',
                        borderColor: 'rgba(255, 193, 7, 1)',
                        borderWidth: 1,
                        yAxisID: 'y',
                        type: 'bar',
                        stack: 'jobs'
                    },
                    {
                        label: 'Resume Wait',
                        data: resumeWait,
                        backgroundColor: 'rgba(23, 162, 184, 0.5)',
                        borderColor: 'rgba(23, 162, 184, 1)',
                        borderWidth: 1,
                        yAxisID: 'y',
                        type: 'bar',
                        stack: 'jobs'
                    },
                    {
                        label: 'Dead',
                        data: dead,
                        backgroundColor: 'rgba(220, 53, 69, 0.5)',
                        borderColor: 'rgba(220, 53, 69, 1)',
                        borderWidth: 1,
                        yAxisID: 'y',
                        type: 'bar',
                        stack: 'jobs'
                    },
                    {
                        label: 'Completed Rate (%)',
                        data: completedRate,
                        backgroundColor: 'rgba(0,0,0,0)',
                        borderColor: 'rgba(0,0,0,1)',
                        borderWidth: 2,
                        yAxisID: 'y2',
                        type: 'line',
                        pointRadius: 2,
                        tension: 0.2
                    }
                ]
            },
            options: {
                responsive: true,
                interaction: { mode: 'index', intersect: false },
                stacked: false,
                plugins: {
                    legend: { position: 'top' },
                    title: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Job Count' }
                    },
                    y2: {
                        beginAtZero: true,
                        position: 'right',
                        title: { display: true, text: 'Completed Rate (%)' },
                        grid: { drawOnChartArea: false }
                    }
                }
            }
        });
    </script>
    <table>
        <thead>
            <tr>
                <th>Hour (JST)</th>
                <th>Total Jobs</th>
                <th>Completed Rate</th>
                <th>Completed</th>
                <th>Running</th>
                <th>Resume Wait</th>
                <th>Dead</th>
                <th>.jp Count Sum</th>
                <th>Log Name Job Counts (desc)</th>
            </tr>
        </thead>
        <tbody>
            {% for row in status_stats %}
            {% set total_jobs = row.status_counts.running + row.status_counts.completed + row.status_counts.resume_wait + row.status_counts.dead %}
            {% set completed_rate = (row.status_counts.completed / total_jobs * 100) if total_jobs > 0 else 0 %}
            <tr>
                <th scope="row"><b>{{ row.hour_label }}</b></th>
                <td>{{ "{:,}".format(total_jobs) }}</td>
                <td>{{ '%.2f' % completed_rate }}%</td>
                <td class="highlight-green">{{ "{:,}".format(row.status_counts.completed) }}</td>
                <td>{{ "{:,}".format(row.status_counts.running) }}</td>
                <td>{{ "{:,}".format(row.status_counts.resume_wait) }}</td>
                <td class="highlight-red">{{ "{:,}".format(row.status_counts.dead) }}</td>
                <td>{{ "{:,}".format(row.jp_count_sum) }}</td>
                <td class="small">
                    {% for log_name, count in row.log_name_counts.items() %}
                        {{ log_name }}: {{ "{:,}".format(count) }}{% if not loop.last %}<br>{% endif %}
                    {% endfor %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <h2>2. Worker Log Stats</h2>
    <table>
        <thead>
            <tr>
                <th>Log Name</th>
                <th>Worker Total Count</th>
                <th>.jp Count</th>
                <th>.jp Ratio</th>
                <th>Last Updated</th>
            </tr>
        </thead>
        <tbody>
            {% for stat in log_stats %}
            <tr>
                <th scope="row"><b>{{ stat.log_name }}</b></th>
                <td>{{ "{:,}".format(stat.worker_total_count) }}</td>
                <td>{{ "{:,}".format(stat.jp_count_sum) }}</td>
                <td>
                    {% if stat.worker_total_count and stat.worker_total_count > 0 %}
                        {{ '%.2f' % (stat.jp_count_sum / stat.worker_total_count * 100) }}%
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>{{ stat.last_updated }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</body>
</html>
