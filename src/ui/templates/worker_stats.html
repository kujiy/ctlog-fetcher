<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Worker Stats - {{ worker_name }}</title>
    <style>
        body { font-family: sans-serif; margin: 2em; }
        h1, h2 { color: #2c3e50; }
        table { border-collapse: collapse; width: 100%; margin-bottom: 2em; }
        th, td { border: 1px solid #ccc; padding: 0.5em; text-align: left; }
        th { background: #f4f4f4; }
        .highlight-green { background-color: #d4edda; }
        .highlight-red { background-color: #f8d7da; }
        .nav-links a { margin-right: 1em; text-decoration: none; color: #3498db; }
        .small { font-size: 0.7em }
    </style>
</head>
<body>
    <div class="nav-links" style="margin-bottom: 2em;">
        <a href="/">üè† Dashboard</a>
        <a href="/unique_certs">üîí Sample Certificates</a>
    </div>
    <h1>Worker Stats: {{ worker_name }}</h1>

    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <div style="display: flex; align-items: center; margin-bottom: 1em;">
        <h2 style="margin-right: 1em; margin-bottom: 0;">1. Worker Status</h2>
        <select id="timeRangeSelector" style="padding: 0.5em; border-radius: 4px; border: 1px solid #ccc;">
            <option value="24,1">24 hours / 1 hour buckets</option>
            <option value="72,1">3 days / 1 hour buckets</option>
            <option value="168,2">7 days / 2 hour buckets</option>
            <option value="336,4">14 days / 4 hour buckets</option>
            <option value="720,24">30 days / 24 hour buckets</option>
            <option value="1440,24">60 days / 24 hour buckets</option>
        </select>
    </div>
    {% set hour_labels_py = [] -%}
    {% set total_jobs_py = [] -%}
    {% set completed_py = [] -%}
    {% set running_py = [] -%}
    {% set resume_wait_py = [] -%}
    {% set dead_py = [] -%}
    {% set completed_rate_py = [] -%}
    {%- for row in status_stats %}
        {%- set _ = hour_labels_py.append(row.hour_label) -%}
        {%- set _ = completed_py.append(row.status_counts.completed) -%}
        {%- set _ = running_py.append(row.status_counts.running) -%}
        {%- set _ = resume_wait_py.append(row.status_counts.resume_wait) -%}
        {%- set _ = dead_py.append(row.status_counts.dead) -%}
        {%- set total = row.status_counts.running + row.status_counts.completed + row.status_counts.resume_wait + row.status_counts.dead -%}
        {%- set _ = total_jobs_py.append(total) -%}
        {%- set _ = completed_rate_py.append(((row.status_counts.completed / total * 100) if total > 0 else 0) | round(2)) -%}
    {%- endfor %}
    <div id="chartContainer">
        <div id="loadingIndicator" style="display: none; text-align: center; padding: 20px;">
            <div style="display: inline-block; width: 30px; height: 30px; border: 3px solid rgba(0,0,0,.1); border-radius: 50%; border-top-color: #3498db; animation: spin 1s ease-in-out infinite;"></div>
            <p>Loading data...</p>
        </div>
        <canvas id="statusChart" width="900" height="320" style="margin-bottom:2em;"></canvas>
    </div>
    <style>
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
    <script>
        // Prepare data arrays from Jinja2 context
        let hourLabels = {{ hour_labels_py | tojson | safe }};
        let totalJobs = {{ total_jobs_py | tojson | safe }};
        let completed = {{ completed_py | tojson | safe }};
        let running = {{ running_py | tojson | safe }};
        let resumeWait = {{ resume_wait_py | tojson | safe }};
        let dead = {{ dead_py | tojson | safe }};
        let completedRate = {{ completed_rate_py | tojson | safe }};

        // Reverse arrays for graph (so latest is rightmost)
        hourLabels = hourLabels.slice().reverse();
        completed = completed.slice().reverse();
        running = running.slice().reverse();
        resumeWait = resumeWait.slice().reverse();
        dead = dead.slice().reverse();
        completedRate = completedRate.slice().reverse();

        let chart = null;

        // Function to create or update the chart
        function createChart() {
            // Destroy existing chart if it exists
            if (chart) {
                chart.destroy();
            }

            // Chart.js config
            const ctx = document.getElementById('statusChart').getContext('2d');
            chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: hourLabels,
                datasets: [
                    {
                        label: 'Completed',
                        data: completed,
                        backgroundColor: 'rgba(40, 167, 69, 0.5)',
                        borderColor: 'rgba(40, 167, 69, 1)',
                        borderWidth: 1,
                        yAxisID: 'y',
                        type: 'bar',
                        stack: 'jobs'
                    },
                    {
                        label: 'Running',
                        data: running,
                        backgroundColor: 'rgba(255, 193, 7, 0.5)',
                        borderColor: 'rgba(255, 193, 7, 1)',
                        borderWidth: 1,
                        yAxisID: 'y',
                        type: 'bar',
                        stack: 'jobs'
                    },
                    {
                        label: 'Resume Wait',
                        data: resumeWait,
                        backgroundColor: 'rgba(23, 162, 184, 0.5)',
                        borderColor: 'rgba(23, 162, 184, 1)',
                        borderWidth: 1,
                        yAxisID: 'y',
                        type: 'bar',
                        stack: 'jobs'
                    },
                    {
                        label: 'Dead',
                        data: dead,
                        backgroundColor: 'rgba(220, 53, 69, 0.5)',
                        borderColor: 'rgba(220, 53, 69, 1)',
                        borderWidth: 1,
                        yAxisID: 'y',
                        type: 'bar',
                        stack: 'jobs'
                    },
                    {
                        label: 'Completed Rate (%)',
                        data: completedRate,
                        backgroundColor: 'rgba(0,0,0,0)',
                        borderColor: 'rgba(0,0,0,1)',
                        borderWidth: 2,
                        yAxisID: 'y2',
                        type: 'line',
                        pointRadius: 2,
                        tension: 0.2
                    }
                ]
            },
            options: {
                responsive: true,
                interaction: { mode: 'index', intersect: false },
                stacked: false,
                plugins: {
                    legend: { position: 'top' },
                    title: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Job Count' }
                    },
                    y2: {
                        beginAtZero: true,
                        position: 'right',
                        title: { display: true, text: 'Completed Rate (%)' },
                        grid: { drawOnChartArea: false }
                    }
                }
            }
        });
        }

        // Function to fetch data for selected time range
        async function fetchDataForTimeRange(hours, bucketHours) {
            try {
                // Show loading indicator
                document.getElementById('loadingIndicator').style.display = 'block';
                document.getElementById('statusChart').style.display = 'none';

                const response = await fetch(`/api/worker_stats/{{ worker_name }}?hours=${hours}&bucket_hours=${bucketHours}`);
                if (!response.ok) {
                    throw new Error(`API returned status code: ${response.status}`);
                }
                const data = await response.json();

                // Extract data from the response
                const statusStats = data.status_stats;

                // Reset data arrays
                hourLabels = [];
                completed = [];
                running = [];
                resumeWait = [];
                dead = [];
                completedRate = [];

                // Process the data
                for (const row of statusStats) {
                    hourLabels.push(row.hour_label);
                    completed.push(row.status_counts.completed);
                    running.push(row.status_counts.running);
                    resumeWait.push(row.status_counts.resume_wait);
                    dead.push(row.status_counts.dead);

                    const total = row.status_counts.running + row.status_counts.completed +
                                 row.status_counts.resume_wait + row.status_counts.dead;
                    const rate = total > 0 ? (row.status_counts.completed / total * 100).toFixed(2) : 0;
                    completedRate.push(parseFloat(rate));
                }

                // Reverse arrays for the chart (latest should be rightmost)
                hourLabels = hourLabels.slice().reverse();
                completed = completed.slice().reverse();
                running = running.slice().reverse();
                resumeWait = resumeWait.slice().reverse();
                dead = dead.slice().reverse();
                completedRate = completedRate.slice().reverse();

                // Update the chart
                createChart();

                // Hide loading indicator and show chart
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('statusChart').style.display = 'block';

                // Update the title text
                const rangeText = hours >= 24 ?
                    (hours === 24 ? '24 hours' :
                     hours === 72 ? '3 days' :
                     hours === 168 ? '7 days' :
                     hours === 336 ? '14 days' :
                     hours === 720 ? '30 days' :
                     hours === 1440 ? '60 days' : `${hours} hours`) :
                    `${hours} hours`;

                const bucketText = bucketHours === 1 ? 'hourly' :
                                  bucketHours === 24 ? 'daily' :
                                  `${bucketHours}-hour buckets`;

                // Update the table with new data if the API provides it
                if (window.updateTable && typeof window.updateTable === 'function') {
                    window.updateTable(data.status_stats);
                }
            } catch (error) {
                console.error('Error fetching data:', error);
                alert(`Failed to load data: ${error.message}`);
                // Hide loading indicator on error
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('statusChart').style.display = 'block';
            }
        }

        // Initialize the chart with initial data
        createChart();

        // Handle time range selection change
        document.getElementById('timeRangeSelector').addEventListener('change', function() {
            const [hours, bucketHours] = this.value.split(',').map(Number);
            fetchDataForTimeRange(hours, bucketHours);
        });
    </script>
    <table>
        <thead>
            <tr>
                <th>Hour (JST)</th>
                <th>Total Jobs</th>
                <th>Completed Rate</th>
                <th>Dead Rate</th>
                <th>Completed</th>
                <th>Dead</th>
                <th>Running</th>
                <th>Resume Wait</th>
                <th>Duration(Avg)</th>
                <th>Duration(Max)</th>
                <th>.jp Count Sum</th>
                <th>Log Name Job Counts (desc)</th>
            </tr>
        </thead>
        <tbody>
            {% for row in status_stats %}
            {% set total_jobs = row.status_counts.running + row.status_counts.completed + row.status_counts.resume_wait + row.status_counts.dead %}
            {% set completed_rate = (row.status_counts.completed / total_jobs * 100) if total_jobs > 0 else 0 %}
            {% set dead_rate = (row.status_counts.dead / total_jobs * 100) if total_jobs > 0 else 0 %}
            <tr>
                <th scope="row"><b>{{ row.hour_label }}</b></th>
                <td>{{ "{:,}".format(total_jobs) }}</td>
                <td>{{ '%.2f' % completed_rate }}%</td>
                <td>{{ '%.2f' % dead_rate }}%</td>
                <td class="highlight-green">{{ "{:,}".format(row.status_counts.completed) }}</td>
                <td class="highlight-red">{{ "{:,}".format(row.status_counts.dead) }}</td>
                <td>{{ "{:,}".format(row.status_counts.running) }}</td>
                <td>{{ "{:,}".format(row.status_counts.resume_wait) }}</td>
                <td>{{ row.duration_min.avg }} mins</td>
                <td>{{ row.duration_min.max }} mins</td>
                <td>{{ "{:,}".format(row.jp_count_sum) }}</td>
                <td class="small">
                    {% for log_name, count in row.log_name_counts.items() %}
                        {{ log_name }}: {{ "{:,}".format(count) }}{% if not loop.last %}<br>{% endif %}
                    {% endfor %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <h2>2. Worker Stats for Last Two Hours</h2>
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Worker Name</th>
                <th>Log Name</th>
{#                <th>CT Log URL</th>#}
                <th>Start</th>
                <th>End</th>
                <th>Current</th>
{#                <th>Last Uploaded Index</th>#}
                <th>Status</th>
                <th>Last Ping</th>
                <th>Created At</th>
                <th>Duration (sec)</th>
                <th>IP Address</th>
                <th>JP Count</th>
                <th>JP Ratio</th>
            </tr>
        </thead>
        <tbody>
            {% for stat in worker_status %}
            <tr
                {% if stat.status == "completed" %}
                    class="highlight-green"
                {% elif stat.status != "running" %}
                    class="highlight-red"
                {% endif %}
            >
                <td>{{ stat.id }}</td>
                <td>{{ stat.worker_name }}</td>
                <td>{{ stat.log_name }}</td>
{#                <td>{{ stat.ct_log_url }}</td>#}
                <td>{{ stat.start }}</td>
                <td>{{ stat.end }}</td>
                <td>{{ stat.current }}</td>
{#                <td>{{ stat.last_uploaded_index }}</td>#}
                <td>
                    {{ stat.status }}
                </td>
                <td>{{ stat.last_ping }}</td>
                <td>{{ stat.created_at }}</td>
                <!-- less than 30 minutes -->
                <td
                    {% if stat.duration_sec and stat.duration_sec < 1800 %}
                        class="highlight-green"
                    {% elif stat.duration_sec %}
                        class="highlight-red"
                    {% endif %}
                >
                    {% if stat.duration_sec %}{{ stat.duration_sec }}{% endif %}
                </td>
                <td>{{ stat.ip_address }}</td>
                <td>{{ stat.jp_count }}</td>
                <td>{{ stat.jp_ratio }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</body>
</html>
