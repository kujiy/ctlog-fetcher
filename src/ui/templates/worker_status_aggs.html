<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CT Log Fetcher - Worker Completion Statistics</title>
    <!-- Favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/images/favicon_io/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/images/favicon_io/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/images/favicon_io/favicon-16x16.png">
    <link rel="manifest" href="/assets/images/favicon_io/site.webmanifest">
    <link rel="shortcut icon" href="/assets/images/favicon_io/favicon.ico">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; margin: 2em; }
        h1 { color: #2c3e50; }
        table { border-collapse: collapse; width: 100%; margin-bottom: 2em; }
        th, td { border: 1px solid #ccc; padding: 0.5em; text-align: left; }
        th { background: #f4f4f4; }
        .nav-links a { margin-right: 1em; text-decoration: none; color: #3498db; }
        .error { color: red; }
        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
            margin-bottom: 2em;
        }
    </style>
</head>
<body>
    <h1>üîç Worker Status Aggregates (Hourly)</h1>

    <div class="nav-links" style="margin-bottom: 2em;">
        <a href="/">üè† Dashboard</a>
        <a href="/metrics">üìä Metrics</a>
    </div>

    {% if error_message %}
        <div class="error">
            <p>Error: {{ error_message }}</p>
        </div>
    {% endif %}

    <section>
    <h2>WorkerStatusAggs Table (All Records)</h2>
    <p>All hourly aggregates of worker status (JobStatusÂà•„Ç´„Ç¶„É≥„ÉàÂê´„ÇÄ)„ÄÇ</p>
        {% if query_timestamp %}
            <p>Data as of: {{ query_timestamp }}</p>
        {% endif %}
        {% if total_records %}
            <p>Total records: {{ total_records }}</p>
        {% endif %}

        {% if aggs %}

            <!-- Chart Container: JobStatus„Åî„Å®„ÅÆÊé®Áßª -->
            <div style="margin-bottom:1em;">
                <label for="daysSelect">Display period: </label>
                <select id="daysSelect">
                    <option value="all">All</option>
                    <option value="60">Last 60 days</option>
                    <option value="30">Last 30 days</option>
                    <option value="7">Last 7 days</option>
                    <option value="3">Last 3 days</option>
                    <option value="1" selected>Last 1 day</option>
                    <option value="custom">Custom</option>
                </select>
                <input type="number" id="customDays" min="1" max="365" placeholder="days" style="width:5em;display:none;">
                <button id="applyDays" style="display:none;">Apply</button>
            </div>
            <div class="chart-container">
                <canvas id="statusAggsChart"></canvas>
            </div>

            <!-- show last_six_hours_average -->
            <h2>Average completed workers in the last 6 hours:</h2>
            <table>
                <thead>
                    <tr>
                        <th>Status</th>
                        <th>Average</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
                {% for status, v in last_six_hours_average.items() %}
                    <tr>
                        <th>{{ status }}</th>
                        <td>{{ v.average }}</td>
                        <td>{{ v.total }}</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>

            <h2>WorkerStatusAggs Table</h2>
            <table>
                <thead>
                    <tr>
                        <th>Start Time</th>
                        <th>End Time</th>
                        <th>Total</th>
                        <th>Completed</th>
                        <th>Running</th>
                        <th>Dead</th>
                        <th>Failed</th>
                        <th>Resume Wait</th>
                        <th>Skipped</th>
                        <th>Worker Name Count</th>
                        <th>Log Name Count</th>
                        <th>JP Count Sum</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in aggs|reverse %}
                    <tr>
                        <td>{{ row.start_time }}</td>
                        <td>{{ row.end_time }}</td>
                        <td>{{ row.total_worker_status_count }}</td>
                        <td>{{ row.completed }}</td>
                        <td>{{ row.running }}</td>
                        <td>{{ row.dead }}</td>
                        <td>{{ row.failed }}</td>
                        <td>{{ row.resume_wait }}</td>
                        <td>{{ row.skipped }}</td>
                        <td>{{ row.worker_name_count }}</td>
                        <td>{{ row.log_name_count }}</td>
                        <td>{{ row.jp_count_sum }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    // Chart.jsÁî®„Éá„Éº„Çø
                    const aggs = {{ aggs|tojson|safe }};
                    const ctx = document.getElementById('statusAggsChart').getContext('2d');
                    // ÂàùÊúü„Éá„Éº„Çø
                    function getDataRows(rows) {
                        return {
                            labels: rows.map(row => row.start_time),
                            completed: rows.map(row => row.completed),
                            running: rows.map(row => row.running),
                            dead: rows.map(row => row.dead),
                            failed: rows.map(row => row.failed),
                            resume_wait: rows.map(row => row.resume_wait),
                            skipped: rows.map(row => row.skipped)
                        };
                    }
                    let dataRows = getDataRows(aggs);
                    let chart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: dataRows.labels,
                            datasets: [
                                { label: 'Completed', data: dataRows.completed, borderColor: 'rgba(52,152,219,1)', backgroundColor: 'rgba(52,152,219,0.1)', borderWidth: 2, tension: 0.3 },
                                { label: 'Running', data: dataRows.running, borderColor: 'rgba(46,204,113,1)', backgroundColor: 'rgba(46,204,113,0.1)', borderWidth: 2, tension: 0.3 },
                                { label: 'Dead', data: dataRows.dead, borderColor: 'rgba(231,76,60,1)', backgroundColor: 'rgba(231,76,60,0.1)', borderWidth: 2, tension: 0.3 },
                                { label: 'Failed', data: dataRows.failed, borderColor: 'rgba(155,89,182,1)', backgroundColor: 'rgba(155,89,182,0.1)', borderWidth: 2, tension: 0.3 },
                                { label: 'Resume Wait', data: dataRows.resume_wait, borderColor: 'rgba(241,196,15,1)', backgroundColor: 'rgba(241,196,15,0.1)', borderWidth: 2, tension: 0.3 },
                                { label: 'Skipped', data: dataRows.skipped, borderColor: 'rgba(127,140,141,1)', backgroundColor: 'rgba(127,140,141,0.1)', borderWidth: 2, tension: 0.3 },
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                x: {
                                    title: { display: true, text: 'Hour' },
                                    ticks: { maxTicksLimit: 20, maxRotation: 45, minRotation: 45 }
                                },
                                y: {
                                    beginAtZero: true,
                                    title: { display: true, text: 'Count' }
                                }
                            },
                            plugins: {
                                title: { display: true, text: 'Worker Status Trend (JobStatus)', font: { size: 16 } },
                                tooltip: {
                                    callbacks: {
                                        title: function(tooltipItems) { return tooltipItems[0].label; },
                                        label: function(context) { return context.dataset.label + ': ' + context.parsed.y; }
                                    }
                                }
                            }
                        }
                    });

                    // Êó•Êï∞ÈÅ∏ÊäûUI
                    const daysSelect = document.getElementById('daysSelect');
                    const customDays = document.getElementById('customDays');
                    const applyDays = document.getElementById('applyDays');


                    // „Éá„Éï„Ç©„É´„Éà„Åß"Last 1 day"„ÇíÈÅ∏Êäû
                    function setDefaultDays() {
                        daysSelect.value = '1';
                        customDays.style.display = 'none';
                        applyDays.style.display = 'none';
                        updateChart(1);
                    }
                    setDefaultDays();

                    daysSelect.addEventListener('change', function() {
                        if (daysSelect.value === 'custom') {
                            customDays.style.display = '';
                            applyDays.style.display = '';
                        } else {
                            customDays.style.display = 'none';
                            applyDays.style.display = 'none';
                            updateChart(daysSelect.value);
                        }
                    });
                    applyDays.addEventListener('click', function() {
                        const val = parseInt(customDays.value, 10);
                        if (!isNaN(val) && val > 0) {
                            updateChart(val);
                        }
                    });

                    function updateChart(days) {
                        let filtered;
                        if (days === 'all') {
                            filtered = aggs;
                        } else {
                            const now = new Date();
                            filtered = aggs.filter(row => {
                                const t = new Date(row.start_time);
                                return (now - t) <= days * 24 * 60 * 60 * 1000;
                            });
                        }
                        let d = getDataRows(filtered);
                        chart.data.labels = d.labels;
                        chart.data.datasets[0].data = d.completed;
                        chart.data.datasets[1].data = d.running;
                        chart.data.datasets[2].data = d.dead;
                        chart.data.datasets[3].data = d.failed;
                        chart.data.datasets[4].data = d.resume_wait;
                        chart.data.datasets[5].data = d.skipped;
                        chart.update();
                    }
                });
            </script>
        {% else %}
            <p>No WorkerStatusAggs records available.</p>
        {% endif %}
    </section>
</body>
</html>
